<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>SecureID Ultra | ZinqCheat</title>
    <link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body onload="initApp()">

<div id="splash-screen">
    <div class="zinq-logo">ZinqCheat</div>
    <p style="font-size: 10px; color: grey; margin-top: 5px;">DECRYPTING PROTOCOLS...</p>
    <div class="loading-bar-container">
        <div class="loading-bar-fill"></div>
    </div>
</div>

<div id="ban-overlay">
    <i class="fas fa-user-slash" style="font-size: 50px; color: var(--danger);"></i>
    <h1 style="color: var(--danger);">ACCESS DENIED</h1>
    <p id="ban-reason" style="opacity: 0.7;"></p>
    <div id="countdown-timer">00:00:00</div>
    <p style="font-size: 12px; opacity: 0.5;">Access will restore automatically when timer ends.</p>
</div>

<div id="privacy-shield">
    <h1 style="color:var(--danger)">SECURITY BREACH</h1>
    <p id="shield-msg">Privacy Shield Active</p>
</div>

<div class="app-container">
    <div id="landing-page" class="page active">
        <h1 style="text-align:center; color: var(--neon); font-size: 32px;">SecureID Ultra</h1>
        <div class="glass-card">
            <button class="btn btn-neon" onclick="showPage('reg-page'); playSound('click') " style="width:100%"><i class="fas fa-user-plus"></i> Register Account</button>
            <div style="height:20px"></div>
            <button class="btn btn-ghost" onclick="showPage('log-page'); playSound('click')" style="width:100%"><i class="fas fa-sign-in-alt"></i> Login with ID</button>
        </div>
    </div>

    <div id="reg-page" class="page">
        <div class="glass-card">
            <button class="back-btn" onclick="showPage('landing-page'); playSound('click')"><i class="fas fa-arrow-left"></i> BACK</button>
            <h3 style="margin-top:20px;">Register Email</h3>
            <input type="email" id="regEmail" placeholder="Email Address">
            <input type="password" id="regPassword" placeholder="Create Password">

            <button class="btn btn-neon" onclick="handleOTP(); playSound('click')" id="otpBtn" style="width:100%">
                <span>Get OTP</span><div class="loader" id="regLoad"></div>
            </button>
            <div id="otpBox" style="display:none; margin-top:15px;">
                <input type="text" id="otpVal" placeholder="6-Digit OTP">
                <button class="btn btn-neon" onclick="finishReg(); playSound('click')" style="width:100%">Verify & Create</button>
            </div>
        </div>
    </div>

    <div id="log-page" class="page">
        <div class="glass-card">
            <button class="back-btn" onclick="showPage('landing-page'); playSound('click')"><i class="fas fa-arrow-left"></i> BACK</button>
            <h3 style="margin-top:20px;">Secure Login</h3>
            <input type="password" id="loginPin" placeholder="How Are U Today!">
            <input type="text" id="loginId" placeholder="ID:xxx-xxx-xxx">
            

            <input type="password" id="loginPassword" placeholder="Account Password">
            <button class="btn btn-ghost" onclick="resetPassword()">Forgot Password?</button>

            
            <button class="btn btn-neon" onclick="doAdvancedLogin(); playSound('click')" style="width:100%">Login Now</button>
        </div>
    </div>

    <div id="dash-page" class="page">
        <div class="glass-card" style="text-align:center;">
            <div id="admin-msg-box"></div>
            <div id="admin-access-btn" style="display:none">
                <span class="admin-badge">ADMIN ACTIVE</span>
                <button class="btn btn-neon" onclick="showPage('admin-panel'); playSound('click')" style="width:100%; margin-bottom:15px; background:var(--danger); color:white;">OPEN CONTROL PANEL</button>
            </div>
            
            <p id="vault-status" style="font-size:10px; color:var(--ghost)"></p>
            <p style="font-size:12px; opacity:0.5;">YOUR IDENTITY</p>
            <h2 id="myId" style="color:var(--neon);">---</h2>
            <button class="btn btn-ghost" onclick="copyID(); playSound('click')"><i class="fas fa-copy"></i> COPY ID</button>
            <hr style="border:0.5px solid #2d3748; margin:25px 0;">
            <input type="text" id="targetId" placeholder="Partner or Group ID">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-neon" onclick="startGhost('private'); playSound('click')">Private</button>
                <button class="btn btn-neon" onclick="startGhost('group'); playSound('click')" style="background:var(--ghost); color:white;">Group</button>
            </div> 
    <div id="network-page" class="page" style="padding:0;">
    <div class="chat-nav">
        <button onclick="showPage('dash-page')"><i class="fas fa-chevron-left"></i></button>
        <span style="color:var(--neon)">MY NETWORK</span>
        <button onclick="ZinqNetwork.addFriend()"><i class="fas fa-plus-circle"></i></button>
    </div>
    <div id="friend-list-ui" class="network-scroll"></div>
</div>

<div id="network-auth-page" class="page">
    <div class="glass-card" style="text-align:center;">
        <i class="fas fa-user-lock vault-icon"></i>
        <h3>Vault Protected</h3>
        <input type="password" id="vaultPinInput" placeholder="Enter PIN">
        <button class="btn btn-neon" onclick="ZinqNetwork.verifyVaultPass()">Unlock</button>
    </div>
</div>
</div>
            <button onclick="logout(); playSound('click')" style="margin-top:20px; background:none; border:none; color:grey;">Logout</button>
        </div>
    </div>

    <div id="admin-panel" class="page">
        <div class="glass-card" style="max-height: 90vh; overflow-y: auto;">
            <button class="back-btn" onclick="showPage('dash-page'); playSound('click')"><i class="fas fa-arrow-left"></i> BACK</button>
            <h3 style="margin-top:25px; color:var(--danger)">Admin Control</h3>
            <div style="margin-bottom:20px;">
                <p style="font-size:12px;">Broadcast Message to All Users:</p>
                <textarea id="broadcastMsg" placeholder="Type message for all users..."></textarea>
                <button class="btn btn-neon" onclick="sendBroadcast(); playSound('click')" style="width:100%">Post Message</button>
            </div>
            <hr style="border:0.5px solid #2d3748;">
            <h4 style="font-size:14px; color:var(--neon)">Reported Users</h4>
            <div id="report-list">
                <p style="font-size:12px; opacity:0.5;">Loading reports...</p>
            </div>
            <hr style="border:0.5px solid #2d3748; margin: 20px 0;">
            <h4 style="font-size:14px; color:var(--ghost)"><i class="fas fa-user-lock"></i> Currently Banned Users</h4>
            <div id="banned-list-admin">
                <p style="font-size:12px; opacity:0.5;">No users in blacklist.</p>
            </div>
        </div>
    </div>

    <div id="report-page" class="page">
        <div class="glass-card">
            <button class="back-btn" onclick="showPage('chat-page'); playSound('click')"><i class="fas fa-arrow-left"></i> CANCEL</button>
            <h3 style="margin-top:20px; color:var(--danger)">Report Violation</h3>
            <input type="text" id="repTargetId" placeholder="Enter ID to Report" readonly>
            <textarea id="repReason" placeholder="Describe the reason for reporting..." style="height:100px;"></textarea>
            <button class="btn btn-neon" onclick="submitFinalReport(); playSound('click')" style="width:100%; background:var(--danger); color:white;">Submit Report</button>
        </div>
    </div>

    <div id="chat-page" class="page" style="padding:0;">
        <div class="chat-nav">
            <button onclick="exitChat(); playSound('click')" style="background:none; border:none; color:var(--neon);"><i class="fas fa-chevron-left"></i></button>
            <span id="chat-title" style="color:var(--neon)"></span>
            <div style="display:flex; gap:10px; align-items:center;">
                <button onclick="openReportModal(); playSound('click')" style="background:none; border:none; color:var(--danger); font-size:12px; font-weight:bold; cursor:pointer;"><i class="fas fa-flag"></i> REPORT</button>
                <button onclick="sendViewOnce(); playSound('click')" class="view-once-btn" title="View Once"><i class="fas fa-eye"></i></button>
                <button onclick="burnChat(); playSound('burn')" style="background:none; border:none; color:var(--ghost);"><i class="fas fa-fire"></i> BURN</button>
            </div>
        </div>
        <div id="msg-flow"></div>
        <div id="typing-status"></div>
        <div class="chat-input">
            <input type="text" id="msgIn" placeholder="Write something..." oninput="handleTyping()" style="margin-bottom:0;">
            <button class="btn btn-neon" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDMMu8Zqa1lG9uJ1m96KCWFx1uwJuZ3Dn4", databaseURL: "https://zinqcheat-default-rtdb.firebaseio.com/", projectId: "zinqcheat" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    emailjs.init("aDv7N0Ry8Yq1VsNlw");

    const sounds = {
        click: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
        msgSend: new Audio('https://assets.mixkit.co/active_storage/sfx/2357/2357-preview.mp3'),
        msgRec: new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3'),
        alert: new Audio('https://assets.mixkit.co/active_storage/sfx/2533/2533-preview.mp3'),
        burn: new Audio('https://assets.mixkit.co/active_storage/sfx/514/514-preview.mp3')
    };
    function playSound(name) { 
        if(sounds[name]) { 
            sounds[name].currentTime = 0; 
            sounds[name].play().catch(() => {});
        } 
    }

    let myUid = "", userEmail = "", currentOTP = "", chatType = "", partnerUid = "", partnerActive = false, typingTimeout, banInterval;
    const SALT = "ZinqKey99";
    const KILL_CODE = "#WIPE_DEVICE";
    const FAKE_PIN = "0000"; 
    const ADMIN_EMAIL = "shakibscrd@gmail.com";
    const BANNED_LIST = ["bomb", "kill", "drug", "hack", "scam", "weapon", "terror", "abuse", "suicide", "murder", "harm", "illegal","Shahzeb","Shahzeb Choudhary"];
    const SESSION_TTL = 60 * 1000; // 1 minute heartbeat

    // NEW INIT FUNCTION FOR SPLASH
    function initApp() {
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => { 
                splash.style.display = 'none'; 
                checkSavedSession();
            }, 500);
        }, 2500); // Shows splash for 2.5 seconds
    }

    function listenForBroadcast() {
        db.ref('broadcast').on('value', snap => {
            const msg = snap.val();
            const box = document.getElementById('admin-msg-box');
            if(msg) { box.innerText = "ADMIN NOTICE: " + msg; box.style.display = 'block'; playSound('alert'); }
            else { box.style.display = 'none'; }
        });
    }

    function checkAdminStatus() {
        if(userEmail === ADMIN_EMAIL) {
            document.getElementById('admin-access-btn').style.display = 'block';
            loadReports();
            loadAdminBlacklist();
        }
    }

    function sendBroadcast() {
        const msg = document.getElementById('broadcastMsg').value;
        db.ref('broadcast').set(msg).then(() => {
            alert("Broadcast sent!");
            document.getElementById('broadcastMsg').value = "";
        });
    }

    function loadReports() {
        db.ref('reports').on('value', snap => {
            const list = document.getElementById('report-list');
            list.innerHTML = "";
            if(!snap.exists()) list.innerHTML = "No reports found.";
            snap.forEach(child => {
                const r = child.val();
                list.innerHTML += `
                    <div class="report-item">
                        <b>Target ID:</b> ${r.target}<br>
                        <b>Reason:</b> ${r.reason}<br>
                        <b>By:</b> ${r.reporter}<br>
                        <button class="ban-btn" onclick="adminBanUser('${r.target}', 'perm'); playSound('click')">PERMANENT</button>
                        <button class="temp-ban-btn" onclick="adminBanUser('${r.target}', 'temp'); playSound('click')">24H BAN</button>
                    </div>`;
            });
        });
    }

    function loadAdminBlacklist() {
        db.ref('blacklist').on('value', snap => {
            const list = document.getElementById('banned-list-admin');
            list.innerHTML = "";
            if(!snap.exists()) {
                list.innerHTML = "<p style='font-size:12px; opacity:0.5;'>No banned users found.</p>";
                return;
            }
            snap.forEach(child => {
                const data = child.val();
                const rawId = child.key;
                const formattedId = rawId.replace(/(\d{3})(\d{3})(\d{3})/, "$1-$2-$3");
                list.innerHTML += `
                    <div class="report-item banned">
                        <b style="color:#2ecc71">BANNED ID: ${formattedId}</b><br>
                        <b>Email:</b> ${data.email || 'N/A'}<br>
                        <b>Type:</b> ${data.type.toUpperCase()}<br>
                        <b>Reason:</b> ${data.reason || 'N/A'}<br>
                        <button class="unblock-btn" onclick="adminUnblockUser('${formattedId}'); playSound('click')">
                            <i class="fas fa-unlock"></i> UNBLOCK THIS USER
                        </button>
                    </div>`;
            });
        });
    }

    async function adminBanUser(id, type) {
        const idKey = id.replace(/-/g,"");
        let banReason = "";
        let targetEmail = "";

        const userSnap = await db.ref('id_to_email/' + idKey).once('value');
        if(userSnap.exists()) { targetEmail = userSnap.val(); }

        if(type === 'perm') {
            if(!confirm("Perm Ban " + id + "?")) return;
            banReason = "PERMANENT BAN: Your ID has been permanently blocked by Admin for security violations.";
            await db.ref('blacklist/' + idKey).set({ type: "perm", reason: "Admin Banned", timestamp: Date.now(), email: targetEmail });
        } else {
            if(!confirm("Ban " + id + " for 24 Hours?")) return;
            banReason = "SUSPENSION: Your ID is blocked for 24 Hours due to policy violation.";
            const until = Date.now() + (24 * 60 * 60 * 1000);
            await db.ref('blacklist/' + idKey).set({ type: "temp", until: until, reason: "Temporary Suspension", email: targetEmail });
        }

        if(targetEmail) {
            emailjs.send("service_ruuzmdf", "template_xxcgwad", { 
                to_email: targetEmail, 
                otp_code: `SECURITY ALERT: ${banReason}` 
            });
        }
        alert("Action complete for " + id);
    }

    async function adminUnblockUser(id) {
        if(!confirm("Confirm unblocking user: " + id + "?")) return;
        const idKey = id.replace(/-/g,"");
        const banSnap = await db.ref('blacklist/' + idKey).once('value');
        const targetEmail = banSnap.exists() ? banSnap.val().email : "";

        await db.ref('blacklist/' + idKey).remove();

        if(targetEmail) {
            emailjs.send("service_ruuzmdf", "template_xxcgwad", { 
                to_email: targetEmail, 
                otp_code: `ACCESS RESTORED: Your SecureID ${id} has been unblocked by the Admin. You can now login.` 
            });
        }
        alert("User " + id + " has been successfully unblocked.");
    }

    function openReportModal() {
        if(!partnerUid) return alert("No user detected.");
        document.getElementById('repTargetId').value = partnerUid;
        showPage('report-page');
    }

    async function submitFinalReport() {
        const reason = document.getElementById('repReason').value;
        const target = document.getElementById('repTargetId').value;
        if(!reason) return alert("Please enter reason.");
        await db.ref('reports').push({ target, reporter: myUid, reason, timestamp: Date.now() });
        emailjs.send("service_ruuzmdf", "template_xxcgwad", { to_email: "ADMIN", otp_code: `REPORT ID: ${target} REASON: ${reason}` });
        alert("Report Sent.");
        showPage('chat-page');
    }

    function checkContentSafety(text) {
        const lower = text.toLowerCase();
        if (BANNED_LIST.some(word => lower.includes(word))) {
            playSound('alert');
            alert("VIOLATION DETECTED.");
            triggerViolation(); 
            return false;
        }
        return true;
    }

    let lastX, lastY, lastZ;
    window.addEventListener('devicemotion', (e) => {
        let acc = e.accelerationIncludingGravity;
        if(lastX) {
            let diff = Math.abs(acc.x + acc.y + acc.z - lastX - lastY - lastZ);
            if (diff > 55) logout(); 
        }
        lastX = acc.x; lastY = acc.y; lastZ = acc.z;
    });

    function triggerFlashbang() {
        playSound('alert');
        document.body.classList.add('flashbang');
        setTimeout(() => document.body.classList.remove('flashbang'), 500);
        triggerViolation(); 
    }

    async function checkBanStatus(id) {
        if(!id) return false;
        const idKey = id.replace(/-/g,"");
        const banData = await db.ref('blacklist/' + idKey).once('value');
        if (banData.exists()) {
            const data = banData.val();
            if(data.type === "perm") {
                playSound('alert');
                alert("THIS ID IS PERMANENTLY BANNED.");
                return true;
            }
            if(data.type === "temp") {
                if(Date.now() < data.until) {
                    showBanCountdown(data.until, data.reason);
                    return true;
                } else {
                    await db.ref('blacklist/' + idKey).remove();
                    return false;
                }
            }
        }
        return false;
    }

    function showBanCountdown(until, reason) {
        playSound('alert');
        document.getElementById('ban-overlay').style.display = 'flex';
        document.getElementById('ban-reason').innerText = "Reason: " + reason;
        clearInterval(banInterval);
        banInterval = setInterval(() => {
            const now = Date.now();
            const diff = until - now;
            if(diff <= 0) {
                clearInterval(banInterval);
                document.getElementById('ban-overlay').style.display = 'none';
                location.reload();
                return;
            }
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const secs = Math.floor((diff % (1000 * 60)) / 1000);
            document.getElementById('countdown-timer').innerText = 
                `${String(hours).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
        }, 1000);
    }

    async function triggerViolation() {
        if (!myUid) return;
        const idKey = myUid.replace(/-/g,"");
        await db.ref('blacklist/' + idKey).set({ type: "perm", reason: "Harmful Content", email: userEmail });
        if(userEmail) {
            emailjs.send("service_ruuzmdf", "template_xxcgwad", { 
                to_email: userEmail, 
                otp_code: `CRITICAL NOTICE: Your ID ${myUid} has been automatically banned permanently due to content safety violations.` 
            });
        }
        setTimeout(() => logout(), 1000);
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'chat-page') {
            const flow = document.getElementById('msg-flow');
            setTimeout(() => { flow.scrollTop = flow.scrollHeight; }, 100);
        }
    }

    async function checkSavedSession() {
        const id = localStorage.getItem('ghost_id');
        const email = localStorage.getItem('ghost_email');
        if(id) {
            if (await checkBanStatus(id)) return;
            myUid = id; userEmail = email;
            document.getElementById('myId').innerText = id; 
            checkAdminStatus();
            listenForBroadcast();
            showPage('dash-page'); 
        }
    }

    function doAdvancedLogin() {
        const pin = document.getElementById('loginPin').value;
        const id = document.getElementById('loginId').value;
        if(pin === FAKE_PIN) {
            myUid = "999-000-999"; 
            document.getElementById('myId').innerText = myUid;
            showPage('dash-page');
        } else {
            doLogin();
        }
    }

    function handleOTP() {
        userEmail = document.getElementById('regEmail').value;
        if(!userEmail) return;
        document.getElementById('regLoad').style.display = 'inline-block';
        currentOTP = Math.floor(100000 + Math.random() * 900000).toString();
        emailjs.send("service_ruuzmdf", "template_xxcgwad", { to_email: userEmail, otp_code: currentOTP })
            .then(() => { 
                document.getElementById('regLoad').style.display = 'none'; 
                document.getElementById('otpBox').style.display = 'block'; 
            });
    }

    async function finishReg() {
        if(document.getElementById('otpVal').value !== currentOTP) return;
        const eKey = btoa(userEmail).replace(/=/g,"");
        const snap = await db.ref('users/' + eKey).once('value');
        myUid = snap.exists() ? snap.val() : (Math.random().toString().slice(2,11).replace(/(\d{3})(\d{3})(\d{3})/, "$1-$2-$3"));
        const idKey = myUid.replace(/-/g,"");
        if(!snap.exists()) {
            await db.ref('users/' + eKey).set(myUid);
            await db.ref('id_to_email/' + idKey).set(userEmail);
        }
        localStorage.setItem('ghost_email', userEmail);
        const pass = document.getElementById("regPassword").value;
if (!pass || pass.length < 6) {
    alert("Password must be at least 6 characters");
    return;
}

const passHash = CryptoJS.SHA256(pass + SALT).toString();
await db.ref("passwords/" + idKey).set(passHash);

        doLoginWithId(myUid);
    }

    // async function doLogin() {
    //     const id = document.getElementById('loginId').value;
    //     if (await checkBanStatus(id)) return;
    //     doLoginWithId(id);
    //     startSessionLock();

    // }

    async function doLogin() {
    const id = document.getElementById('loginId').value;
    const pass = document.getElementById('loginPassword').value;

    if (!id || !pass) {
        alert("ID and password required");
        return;
    }

    if (await checkBanStatus(id)) return;

    const idKey = id.replace(/-/g,"");
    const snap = await db.ref("passwords/" + idKey).once("value");

    if (!snap.exists()) {
        alert("Password not set for this ID");
        return;
    }

    const hash = CryptoJS.SHA256(pass + SALT).toString();
    if (snap.val() !== hash) {
        alert("Invalid password");
        return;
    }

    doLoginWithId(id);
}


    function doLoginWithId(id) {
        myUid = id; localStorage.setItem('ghost_id', id);
        document.getElementById('myId').innerText = id; 
        checkAdminStatus();
        listenForBroadcast();
        showPage('dash-page');
    }
   
    async function resetPassword() {
    const email = prompt("Enter your registered email:");
    if (!email) return;

    const eKey = btoa(email).replace(/=/g,"");
    const snap = await db.ref("users/" + eKey).once("value");

    if (!snap.exists()) {
        alert("Email not found");
        return;
    }

    const id = snap.val();
    const newPass = Math.random().toString(36).slice(-8);
    const hash = CryptoJS.SHA256(newPass + SALT).toString();

    await db.ref("passwords/" + id.replace(/-/g,"")).set(hash);

    emailjs.send("service_ruuzmdf", "template_xxcgwad", {
        to_email: email,
        otp_code: `Your new password: ${newPass}`
    });

    alert("New password sent to email");
}

    function startGhost(type) {
        chatType = type;
        partnerUid = document.getElementById('targetId').value;
        if(!partnerUid) return;
        if(type === 'private') {
            db.ref('presence/' + myUid).set(getRoom());
            db.ref('presence/' + partnerUid).on('value', s => {
                partnerActive = (s.val() === getRoom());
                if(s.val() === getRoom()) openChatPage("Secure Private");
            });
        } else {
            openChatPage("Group Chat");
        }
    }

    function openChatPage(title) {
        document.getElementById('chat-title').innerText = title;
        showPage('chat-page');
        listen();
    }

    function handleTyping() {
        if(chatType !== 'private') return;
        db.ref('typing/' + getRoom() + '/' + myUid).set(true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => db.ref('typing/' + getRoom() + '/' + myUid).set(false), 2000);
    }

    function exitChat() {
        db.ref('presence/' + myUid).remove();
        showPage('dash-page');
    }

    let lastMsgCount = 0;
    function listen() {
        db.ref('chats/' + getRoom() + '/msgs').on('value', snap => {
            const flow = document.getElementById('msg-flow'); flow.innerHTML = "";
            let newCount = 0;
            snap.forEach(c => {
                newCount++;
                const d = c.val();
                try {
                    const text = CryptoJS.AES.decrypt(d.content, SALT).toString(CryptoJS.enc.Utf8);
                    if(text === KILL_CODE && d.sender !== myUid) { logout(); return; }
                    const isMe = d.sender === myUid;
                    const readStatus = (d.wasRead || (isMe && partnerActive)) ? "read" : "";
                    const receipt = isMe ? `<span class="receipt ${readStatus}"><i class="fas fa-check-double"></i></span>` : "";
                    if(d.viewOnce && !isMe) {
                        flow.innerHTML += `<div class="msg other" onclick="viewAndDestroy('${c.key}')" style="cursor:pointer; font-style:italic;"><i class="fas fa-eye"></i> View Once Message</div>`;
                    } else {
                        flow.innerHTML += `<div class="msg ${isMe?'me':'other'}"><span class="sender-tag">${d.sender}</span>${text}${receipt}</div>`;
                    }
                } catch(e) {}
            });
            if(newCount > lastMsgCount) {
                const msgs = snap.val();
                if(msgs) {
                    const lastMsg = Object.values(msgs).pop();
                    if(lastMsg.sender !== myUid) playSound('msgRec');
                }
            }
            lastMsgCount = newCount;
            flow.scrollTop = flow.scrollHeight;
        });
    }

    function sendMsg() {
        const val = document.getElementById('msgIn').value; if(!val) return;
        if(!checkContentSafety(val)) return; 
        const enc = CryptoJS.AES.encrypt(val, SALT).toString();
        db.ref('chats/' + getRoom() + '/msgs').push({ sender: myUid, content: enc, timestamp: Date.now(), wasRead: partnerActive });
        playSound('msgSend');
        document.getElementById('msgIn').value = "";
    }

    function sendViewOnce() {
        const val = document.getElementById('msgIn').value; if(!val) return;
        if(!checkContentSafety(val)) return; 
        const enc = CryptoJS.AES.encrypt("ðŸ‘ï¸ " + val, SALT).toString();
        db.ref('chats/' + getRoom() + '/msgs').push({ sender: myUid, content: enc, timestamp: Date.now(), viewOnce: true });
        playSound('msgSend');
        document.getElementById('msgIn').value = "";
    }

    function burnChat() { db.ref('chats/' + getRoom()).remove(); playSound('burn'); }
    function getRoom() { return chatType==='private' ? [myUid, partnerUid].sort().join("").replace(/-/g,"") : partnerUid.replace(/-/g,""); }
    function logout() { localStorage.clear(); location.reload(); }
    function copyID() { navigator.clipboard.writeText(myUid); alert("ID Copied!"); }

    window.addEventListener('keyup', (e) => { if (e.key === 'PrintScreen') triggerFlashbang(); });
    window.onblur = () => { document.getElementById('privacy-shield').style.display='flex'; playSound('alert'); }
    window.onfocus = () => document.getElementById('privacy-shield').style.display='none';

    function getDeviceId() {
    let id = localStorage.getItem("device_id");
    if (!id) {
        id = CryptoJS.SHA256(navigator.userAgent + Date.now()).toString();
        localStorage.setItem("device_id", id);
    }
    return id;
}

function startSessionLock() {
    const idKey = myUid.replace(/-/g,"");
    const deviceId = getDeviceId();

    const ref = db.ref(`sessions/${idKey}`);

    ref.set({
        device: deviceId,
        lastSeen: Date.now()
    });

    setInterval(() => {
        ref.once("value").then(snap => {
            if (!snap.exists()) return logout();
            const data = snap.val();
            if (data.device !== deviceId) {
                alert("This ID is logged in from another device.");
                logout();
            } else {
                ref.update({ lastSeen: Date.now() });
            }
        });
    }, SESSION_TTL);
}

</script>
</body>

</html>
